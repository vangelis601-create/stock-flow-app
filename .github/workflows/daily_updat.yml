name: Daily Stock Data Update

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run updater script
        run: python data_updater.py

      - name: Commit and push changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add data/stock_data.csv
          
          # 檢查是否有變動
          if [[ -n $(git status -s) ]]; then
            echo "偵測到資料變動，準備提交..."
            git commit -m "Auto-update stock data $(date +'%Y-%m-%d')"
            
            # --- 關鍵防撞機制 ---
            # 嘗試拉取最新版本並合併 (Rebase)
            # 如果失敗，通常是因為同時改了同一個檔案，但我們這邊通常不會
            git pull --rebase origin main
            
            # 推送
            git push
          else
            echo "無資料變動，跳過提交。"
          fi
